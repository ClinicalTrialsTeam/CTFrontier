[![Build checks](https://github.com/ClinicalTrialsTeam/ctfrontier/actions/workflows/checks.yml/badge.svg)](https://github.com/ClinicalTrialsTeam/ctfrontier/actions/workflows/checks.yml)

# Clinical Trials Project

## Prerequisites

* Docker installed and running
* Python 3.8
* Node.js 15.12.0+


## Setup

1. Clone the repo
1. In the "backend/core" folder there is a file `example.env`.
Copy this into a new `.env` file and fill it in (this .env file be in the "backend/core" folder).
`DJANGO_SECRET` should be a value you get from running `python scripts/gen_random_key.py`
`DB_PASSWORD` can be whatever you want.
1. Before building your docker images, it might be a good idea to run `docker system prune` to clear some space in case you have any previous docker images laying around.
1. Build the docker image `docker-compose build` (This may take a little while)
1. Follow the steps below for "Running the project"

#### Developers-only
1. Run `pip install -r requirements-dev.txt`.
1. Install ESLint and Python linting packages to your IDE. (Suggestions for VSCode users: [Python package](https://marketplace.visualstudio.com/items?itemName=ms-python.python), [ESLint](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint))
1. Optionally, install the pre-commit check which will make sure your code passes the github checks before you commit: `pre-commit install` (see Linting - Django/Python).

## Running the project

1. Run the project with `docker-compose up`
1. If all goes well, the resources below ("where to find things") should be accessible.
1. Run `docker-compose down` or just `ctrl-C` to take everything down

#### Where to find things (list of containers and ports also available using `docker ps`)

* React <http://localhost:3000>
* Django REST API framework <http://localhost:8000> (see backend documentation for specific endpoints)
* Elasticsearch <http://localhost:9200>
* Kibana <http://localhost:5601>


## File Structure

	.
	├── .gitignore
	├── README.md
	├── backend 
	├── cdk 	
	├── frontend
	├── database
	├── scripts				
	└── docker-compose.yml
	
`.gitignore` - Project wide gitignore

`backend` - Folder for all Django server code.

`cdk` - AWS CDK infrastructure code

`frontend` - Folder for all React client code.

`database` - Folder available to the pgdb Docker container. Put database scripts and example inputs here.

`scripts` - Folder for any helpful scripts not directly part of the project.

`docker-compose.yml` - A docker file that defines how the react, django and pgdb docker containers will be run together. (The pgdb doesn't have its own docker file because the base setup for the postgres container is using a predefined image from dockerhub `image: postgres` without much additional setup needed).

`frontend/Dockerfile` - A Dockerfile that defines the base build for the django Docker container. This does some initial setup and installation of libraries on the django build. This file is run by the `docker-compose.yml` file by this line: `build: ./frontend`

`backend/Dockerfile` - A Dockerfile that defines the base build for the django Docker container. This does some initial setup and installation of libraries on the django build. This file is run by the `docker-compose.yml` file by this line: `build: ./backend`

`backend/requirements.in` - This is where you would add python libraries that you want to include in the project.

`backend/requirements.txt` - This file should NOT be manually edited. This file is auto generated by a script that takes in the `requirements.in` and outputs a `requirements.txt` file with the proper versions of each library.

## Other useful commands

### Docker

`docker images` - see your docker images

`docker ps` - see your currently running docker containers

`docker-compose up -d` - Start docker in detatched mode if you don't want to
see logs. However, if you do this don't forget to use `docker-compose down`
to take them down later. Use `docker ps` to see if you have any images
currently running that you might have forgotten about.

`docker logs <service> --follow` - To see the live log output of a particular
service. For example `docker logs react --follow`.

`docker system prune -a` - To clear out all unused containers, networks and images.
This may free up some space if you have some docker things laying around that you
forgot about. However, `docker-compose up` will take longer the next time you run
it because everything will have to rebuild.

## Connect to the containers

### react
`docker exec -it react /bin/bash`

### django
`docker exec -it django /bin/sh`

### pgdb
`docker exec -it pgdb /bin/bash` (note: you can only access the db as the user postges so if you connect this way you may need to switch users)

or to go straight into psql `docker exec -it pgdb psql -U postgres`

## Linting

Linting enforces common code style rules. It can help keep everyone's code consistent and can prevent common errors.

### React/JavaScript 
This project has an ESLint configuration file. You will need to install ESLint package to give you hints in your IDE on how to fix the linting errors. The React project will not compile with ESLint errors.

For VSCode this is the package to install:
[VSCode ESLint](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint)

### Django/Python

For Python we use black autoformatter because it's the simplest to use. To run it on your code simply run `black backend` and it will automatically clean up your code.

**Pre-commit check**  
If you forget to run `black backend` to reformat your code, the pre-commit check will fail when you attempt to commit and it will automatically format your files for you. When this happens, simply add the modified files and try to commit again - this time it should pass.

**Github action**  
There is also a Github action that automatically checks for linting errors. See the result of these checks here: [https://github.com/ClinicalTrialsTeam/ctfrontier/actions](https://github.com/ClinicalTrialsTeam/ctfrontier/actions)
